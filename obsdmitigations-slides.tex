% Copyright (c) 2023 Alexander Bluhm <bluhm@genua.de>
%
% Permission to use, copy, modify, and distribute this software for any
% purpose with or without fee is hereby granted, provided that the above
% copyright notice and this permission notice appear in all copies.
%
% THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
% WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
% MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
% ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
% WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
% ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
% OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.

\documentclass[14pt,aspectratio=169]{beamer}
\usetheme{Frankfurt}
\usepackage{tikz}
\usepackage{graphicx}
\usepackage{tipa}
\usepackage{alltt}
\usepackage{xcolor}
\usepackage{upquote}
\usepackage[T1]{fontenc}
\usepackage{textcomp}
\author{Alexander Bluhm}
\title{OpenBSD Security Mitigations}
\institute{genua GmbH\\ \url{bluhm@genua.de}\\ \url{bluhm@openbsd.org}}
\date{September 2023}
\let\Tiny\tiny

\begin{document}

\begin{frame}
\titlepage
\end{frame}

\begin{frame}{Agenda}
\setcounter{tocdepth}{1}
\tableofcontents
\end{frame}

\section{Memory Corruption}

\subsection{Stack Overflow}
\begin{frame}{Stack Overflow}
\begin{itemize}
  \item non executable
  \item random gap, random location
\end{itemize}
\end{frame}

\subsection{Heap Overflow}
\begin{frame}{Heap Overflow}
\begin{itemize}
  \item Malloc options
  \item Guard page
  \item Random chunk order
  \item Canaries
\end{itemize}
\end{frame}

\subsection{Heap Use-After-Free}
\begin{frame}{Heap Use-After-Free}
\begin{itemize}
  \item unmap freed
  \item junk at alloc
  \item junk at free
  \item SSH use-after-free
  \item random order
\end{itemize}
\end{frame}

\subsection{Return Oriented Programming}
\begin{frame}{Return Oriented Programming}
\begin{itemize}
  \item map stack
  \item retpoline
  \item fork+exec
  \item signal cookie
  \item arm64 BTI \& Intel IBT endbr64
Random relinking
\end{itemize}
\end{frame}

\subsection{mprotect(2)}
\begin{frame}{mprotect(2)}
\begin{itemize}
  \item W\^{}X
  \item xonly
  \item mimmutable(2)
  \item MAP\_STACK
  \item MAP\_CONCEAL
\end{itemize}
\end{frame}

\subsection{Opportunistic xonly}
\begin{frame}[fragile=singleslide]{Opportunistic xonly}
\begin{verbatim}
  addr = mmap(NULL, 4096, PROT_NONE,
      MAP_PRIVATE | MAP_ANON, -1, 0);
  mprotect(addr, 4096, PROT_READ);
  printf("%p: %08x\n", addr, *(int* )addr);
  mprotect(addr, 4096, PROT_EXEC);
  printf("%p: %08x\n", addr, *(int* )addr);
\end{verbatim}
\begin{verbatim}
  0x73d15433000: 00000000
  0x73d15433000: 00000000
\end{verbatim}
\end{frame}

\subsection{Trap xonly}
\begin{frame}[fragile=singleslide]{Trap xonly}
\begin{verbatim}
  addr = mmap(NULL, 4096, PROT_NONE,
      MAP_PRIVATE | MAP_ANON, -1, 0);
  mprotect(addr, 4096, PROT_READ);
  mprotect(addr, 4096, PROT_EXEC);
  printf("%p: %08x\n", addr, *(int* )addr);
\end{verbatim}
\begin{verbatim}
  Segmentation fault (core dumped)
\end{verbatim}
\end{frame}

\section{Random}

\subsection{Random Everywhere}
\begin{frame}{Random Everywhere}
\begin{itemize}
  \item arc4random(3)
  \item arc4random\_uniform(3)
  \item getentropy(2)
  \item ELF header .openbsd.randomdata
  \item boot /etc/random.seed
\end{itemize}
\end{frame}

\subsection{Address Space Layout Randomization}
\begin{frame}{Address Space Layout Randomization}
\begin{enumerate}
  \item shared library mapping
  \item heap mmap(2)
  \item stack gap
  \item PIE program text
  \item relink libc
  \item relink sshd(8)
\end{enumerate}
\end{frame}

\section{Not yet}
\begin{frame}{Not Yet}
\begin{itemize}
  \item ARM pointer authentication
  \item shadow stack
\end{itemize}
\end{frame}

\subsection{Questions}
\begin{frame}{Questions}
\begin{center}
\begin{tikzpicture}
\draw [font=\Huge] node {?};
\end{tikzpicture}
\end{center}
\end{frame}

\end{document}
